/**
 * Update Opportunity Command
 * Generated by entity codegen - do not edit directly
 *
 * EXTENSION POINTS (add business logic here):
 * - Validation: Add domain validation rules (e.g., state transitions)
 * - Authorization: Check if user can modify this specific record
 * - Conflict detection: Optimistic locking, version checks
 * - Side effects: Emit events, invalidate caches, notify subscribers
 * - Audit: Log changes for compliance/debugging
 */

import { Inject, Injectable, NotFoundException } from '@nestjs/common';
import { OPPORTUNITY_REPOSITORY } from '../../../constants';
import type { IOpportunityRepository, UpdateOpportunityInput } from '../../../domain';
import { Opportunity } from '../../../domain';
import type { UpdateOpportunityDto } from '../../schemas';

@Injectable()
export class UpdateOpportunityCommand {
	constructor(
		@Inject(OPPORTUNITY_REPOSITORY)
		private readonly opportunityRepository: IOpportunityRepository,
	) {}

	async execute(id: string, dto: UpdateOpportunityDto): Promise<Opportunity> {
		const existing = await this.opportunityRepository.findById(id);
		if (!existing) {
			throw new NotFoundException(`Opportunity with id ${id} not found`);
		}

		// TODO: Add pre-update validation and business rules here
		// e.g., check state transitions, verify user permissions on this record

		// Map DTO to domain input (only include defined fields)
		const input: UpdateOpportunityInput = {
			...(dto.tenantId !== undefined && { tenantId: dto.tenantId }),
			...(dto.name !== undefined && { name: dto.name }),
			...(dto.organizationId !== undefined && { organizationId: dto.organizationId }),
			...(dto.ownerId !== undefined && { ownerId: dto.ownerId }),
			...(dto.stateId !== undefined && { stateId: dto.stateId }),
			...(dto.amount !== undefined && { amount: dto.amount }),
			...(dto.currency !== undefined && { currency: dto.currency }),
			...(dto.expectedCloseDate !== undefined && { expectedCloseDate: dto.expectedCloseDate }),
			...(dto.closedAt !== undefined && { closedAt: dto.closedAt }),
		};

		const updated = await this.opportunityRepository.update(id, input);
		if (!updated) {
			throw new NotFoundException(`Opportunity with id ${id} not found`);
		}

		// TODO: Add post-update side effects here (events, cache invalidation, etc.)

		return updated;
	}
}
