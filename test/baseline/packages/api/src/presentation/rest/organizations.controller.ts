/**
 * Organizations Controller
 * Generated by entity codegen - do not edit directly
 */

import {
	Body,
	Controller,
	Delete,
	Get,
	Param,
	ParseUUIDPipe,
	Post,
	Put,
	Query,
	UsePipes,
} from '@nestjs/common';
import { GetOrganizationByIdQuery } from '../../application/queries/organization/get-by-id.query';
import { ListOrganizationsQuery } from '../../application/queries/organization/list.query';
import {
	type CreateOrganizationDto,
	createOrganizationSchema,
	type UpdateOrganizationDto,
	updateOrganizationSchema,
} from '../../application/schemas';
import { CreateOrganizationCommand } from '../../application/commands/organization/create.command';
import { DeleteOrganizationCommand } from '../../application/commands/organization/delete.command';
import { UpdateOrganizationCommand } from '../../application/commands/organization/update.command';
import { ZodValidationPipe } from '../../core/pipes/zod-validation.pipe';
import { Organization } from '../../domain';
import type { OrganizationWith } from '../../domain';

@Controller('organizations')
export class OrganizationsController {
	constructor(
		private readonly getOrganizationByIdQuery: GetOrganizationByIdQuery,
		private readonly listOrganizationsQuery: ListOrganizationsQuery,
		private readonly createOrganizationCommand: CreateOrganizationCommand,
		private readonly updateOrganizationCommand: UpdateOrganizationCommand,
		private readonly deleteOrganizationCommand: DeleteOrganizationCommand,
	) {}

	@Get()
	async findAll(@Query('include') include?: string): Promise<Organization[]> {
		return this.listOrganizationsQuery.execute(this.parseInclude(include));
	}

	@Get(':id')
	async findById(
		@Param('id', ParseUUIDPipe) id: string,
		@Query('include') include?: string,
	): Promise<Organization> {
		return this.getOrganizationByIdQuery.execute(id, this.parseInclude(include));
	}

	@Post()
	@UsePipes(new ZodValidationPipe(createOrganizationSchema))
	async create(@Body() dto: CreateOrganizationDto): Promise<Organization> {
		return this.createOrganizationCommand.execute(dto);
	}

	@Put(':id')
	async update(
		@Param('id', ParseUUIDPipe) id: string,
		@Body(new ZodValidationPipe(updateOrganizationSchema)) dto: UpdateOrganizationDto,
	): Promise<Organization> {
		return this.updateOrganizationCommand.execute(id, dto);
	}

	@Delete(':id')
	async delete(@Param('id', ParseUUIDPipe) id: string): Promise<Organization> {
		return this.deleteOrganizationCommand.execute(id);
	}

	/**
	 * Parse comma-separated include query param into typed options.
	 * Example: ?include=account,owner â†’ { account: true, owner: true }
	 */
	private parseInclude(include?: string): OrganizationWith | undefined {
		if (!include) return undefined;
		const parts = include.split(',').map((s) => s.trim());
		return {
			parent: parts.includes('parent'),
			children: parts.includes('children'),
			opportunities: parts.includes('opportunities'),
		};
	}
}
