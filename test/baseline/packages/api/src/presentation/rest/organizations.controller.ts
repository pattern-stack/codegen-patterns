/**
 * Organizations Controller (Electric SQL)
 * Generated by entity codegen - do not edit directly
 */

import {
	Controller,
	Get,
	Body,
	Delete,
	Param,
	ParseUUIDPipe,
	Post,
	Put,
	Req,
	Res,
	UseGuards,
	UsePipes,
} from '@nestjs/common';
import type { Request, Response } from 'express';
import { AuthGuard } from '../../core/guards/auth.guard';
import { CurrentUser } from '../../core/decorators/current-user.decorator';
import type { User } from '../../core/interfaces/user.interface';
import { ElectricService } from '../../core/services/electric.service';
import { organizationsColumns } from '@repo/db/client/schema';
import {
	type CreateOrganizationDto,
	createOrganizationSchema,
	type UpdateOrganizationDto,
	updateOrganizationSchema,
} from '../../application/schemas';
import { CreateOrganizationCommand } from '../../application/commands/organization/create.command';
import { DeleteOrganizationCommand } from '../../application/commands/organization/delete.command';
import { UpdateOrganizationCommand } from '../../application/commands/organization/update.command';
import { GetOrganizationByIdQuery } from '../../application/queries/organization/get-by-id.query';
import { ZodValidationPipe } from '../../core/pipes/zod-validation.pipe';
import { Organization } from '../../domain';

@Controller('organizations')
@UseGuards(AuthGuard)
export class OrganizationsController {
	constructor(
		private readonly electricService: ElectricService,
		private readonly getOrganizationByIdQuery: GetOrganizationByIdQuery,
		private readonly createOrganizationCommand: CreateOrganizationCommand,
		private readonly updateOrganizationCommand: UpdateOrganizationCommand,
		private readonly deleteOrganizationCommand: DeleteOrganizationCommand,
	) {}

	@Get()
	async findAll(
		@CurrentUser() user: User,
		@Req() req: Request,
		@Res() res: Response,
	): Promise<void> {
		return this.electricService.proxyRequest({
			req,
			res,
			table: 'organizations',
			columns: organizationsColumns,
			where: `"tenant_id" = '${user.tenantId}'`,
		});
	}

	@Get(':id')
	async findById(@Param('id', ParseUUIDPipe) id: string): Promise<Organization> {
		return this.getOrganizationByIdQuery.execute(id);
	}

	@Post()
	@UsePipes(new ZodValidationPipe(createOrganizationSchema))
	async create(@Body() dto: CreateOrganizationDto): Promise<Organization> {
		return this.createOrganizationCommand.execute(dto);
	}

	@Put(':id')
	async update(
		@Param('id', ParseUUIDPipe) id: string,
		@Body(new ZodValidationPipe(updateOrganizationSchema)) dto: UpdateOrganizationDto,
	): Promise<Organization> {
		return this.updateOrganizationCommand.execute(id, dto);
	}

	@Delete(':id')
	async delete(@Param('id', ParseUUIDPipe) id: string): Promise<Organization> {
		return this.deleteOrganizationCommand.execute(id);
	}
}
