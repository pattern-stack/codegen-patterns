/**
 * Opportunities Controller
 * Generated by entity codegen - do not edit directly
 */

import {
	Body,
	Controller,
	Delete,
	Get,
	Param,
	ParseUUIDPipe,
	Post,
	Put,
	Query,
	UsePipes,
} from '@nestjs/common';
import { GetOpportunityByIdQuery } from '../../application/queries/opportunity/get-by-id.query';
import { ListOpportunitiesQuery } from '../../application/queries/opportunity/list.query';
import {
	type CreateOpportunityDto,
	createOpportunitySchema,
	type UpdateOpportunityDto,
	updateOpportunitySchema,
} from '../../application/schemas';
import { CreateOpportunityCommand } from '../../application/commands/opportunity/create.command';
import { DeleteOpportunityCommand } from '../../application/commands/opportunity/delete.command';
import { UpdateOpportunityCommand } from '../../application/commands/opportunity/update.command';
import { ZodValidationPipe } from '../../core/pipes/zod-validation.pipe';
import { Opportunity } from '../../domain';
import type { OpportunityWith } from '../../domain';

@Controller('opportunities')
export class OpportunitiesController {
	constructor(
		private readonly getOpportunityByIdQuery: GetOpportunityByIdQuery,
		private readonly listOpportunitiesQuery: ListOpportunitiesQuery,
		private readonly createOpportunityCommand: CreateOpportunityCommand,
		private readonly updateOpportunityCommand: UpdateOpportunityCommand,
		private readonly deleteOpportunityCommand: DeleteOpportunityCommand,
	) {}

	@Get()
	async findAll(@Query('include') include?: string): Promise<Opportunity[]> {
		return this.listOpportunitiesQuery.execute(this.parseInclude(include));
	}

	@Get(':id')
	async findById(
		@Param('id', ParseUUIDPipe) id: string,
		@Query('include') include?: string,
	): Promise<Opportunity> {
		return this.getOpportunityByIdQuery.execute(id, this.parseInclude(include));
	}

	@Post()
	@UsePipes(new ZodValidationPipe(createOpportunitySchema))
	async create(@Body() dto: CreateOpportunityDto): Promise<Opportunity> {
		return this.createOpportunityCommand.execute(dto);
	}

	@Put(':id')
	async update(
		@Param('id', ParseUUIDPipe) id: string,
		@Body(new ZodValidationPipe(updateOpportunitySchema)) dto: UpdateOpportunityDto,
	): Promise<Opportunity> {
		return this.updateOpportunityCommand.execute(id, dto);
	}

	@Delete(':id')
	async delete(@Param('id', ParseUUIDPipe) id: string): Promise<Opportunity> {
		return this.deleteOpportunityCommand.execute(id);
	}

	/**
	 * Parse comma-separated include query param into typed options.
	 * Example: ?include=account,owner â†’ { account: true, owner: true }
	 */
	private parseInclude(include?: string): OpportunityWith | undefined {
		if (!include) return undefined;
		const parts = include.split(',').map((s) => s.trim());
		return {
			organization: parts.includes('organization'),
			owner: parts.includes('owner'),
			state: parts.includes('state'),
		};
	}
}
