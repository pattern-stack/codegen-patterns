---
to: "<%= (exposeRest || exposeElectric) ? `${basePaths.backendSrc}/${paths.controllers}/${plural}.controller.ts` : '' %>"
force: true
---
<% if (exposeRest) { -%>
/**
 * <%= classNamePlural %> Controller
 * Generated by entity codegen - do not edit directly
 */

import {
	Body,
	Controller,
	Delete,
	Get,
	Param,
	ParseUUIDPipe,
	Post,
	Put,
<% if (hasRelationships) { -%>
	Query,
<% } -%>
	UsePipes,
} from '@nestjs/common';
import { <%= getByIdQueryClass %> } from '<%= imports.controllerToGetByIdQuery %>';
import { <%= listQueryClass %> } from '<%= imports.controllerToListQuery %>';
import {
	type Create<%= className %>Dto,
	create<%= className %>Schema,
	type Update<%= className %>Dto,
	update<%= className %>Schema,
} from '<%= imports.controllerToSchemas %>';
import { <%= createCommandClass %> } from '<%= imports.controllerToCreateCommand %>';
import { <%= deleteCommandClass %> } from '<%= imports.controllerToDeleteCommand %>';
import { <%= updateCommandClass %> } from '<%= imports.controllerToUpdateCommand %>';
import { ZodValidationPipe } from '../../core/pipes/zod-validation.pipe';
import { <%= className %> } from '<%= imports.controllerToDomain %>';
<% if (hasRelationships) { -%>
import type { <%= className %>With } from '<%= imports.controllerToDomain %>';
<% } -%>

@Controller('<%= plural %>')
export class <%= classNamePlural %>Controller {
	constructor(
		private readonly get<%= className %>ByIdQuery: <%= getByIdQueryClass %>,
		private readonly list<%= classNamePlural %>Query: <%= listQueryClass %>,
		private readonly create<%= className %>Command: <%= createCommandClass %>,
		private readonly update<%= className %>Command: <%= updateCommandClass %>,
		private readonly delete<%= className %>Command: <%= deleteCommandClass %>,
	) {}

	@Get()
	async findAll(<%- hasRelationships ? `@Query('include') include?: string` : '' %>): Promise<<%= className %>[]> {
<% if (hasRelationships) { -%>
		return this.list<%= classNamePlural %>Query.execute(this.parseInclude(include));
<% } else { -%>
		return this.list<%= classNamePlural %>Query.execute();
<% } -%>
	}

	@Get(':id')
	async findById(
		@Param('id', ParseUUIDPipe) id: string,
<% if (hasRelationships) { -%>
		@Query('include') include?: string,
<% } -%>
	): Promise<<%= className %>> {
<% if (hasRelationships) { -%>
		return this.get<%= className %>ByIdQuery.execute(id, this.parseInclude(include));
<% } else { -%>
		return this.get<%= className %>ByIdQuery.execute(id);
<% } -%>
	}

	@Post()
	@UsePipes(new ZodValidationPipe(create<%= className %>Schema))
	async create(@Body() dto: Create<%= className %>Dto): Promise<<%= className %>> {
		return this.create<%= className %>Command.execute(dto);
	}

	@Put(':id')
	async update(
		@Param('id', ParseUUIDPipe) id: string,
		@Body(new ZodValidationPipe(update<%= className %>Schema)) dto: Update<%= className %>Dto,
	): Promise<<%= className %>> {
		return this.update<%= className %>Command.execute(id, dto);
	}

	@Delete(':id')
	async delete(@Param('id', ParseUUIDPipe) id: string): Promise<<%= className %>> {
		return this.delete<%= className %>Command.execute(id);
	}
<% if (hasRelationships) { -%>

	/**
	 * Parse comma-separated include query param into typed options.
	 * Example: ?include=account,owner â†’ { account: true, owner: true }
	 */
	private parseInclude(include?: string): <%= className %>With | undefined {
		if (!include) return undefined;
		const parts = include.split(',').map((s) => s.trim());
		return {
<% relationships.forEach((rel) => { -%>
			<%= rel.name %>: parts.includes('<%= rel.name %>'),
<% }) -%>
		};
	}
<% } -%>
}
<% } -%>
<% if (exposeElectric) { -%>
/**
 * <%= classNamePlural %> Controller (Electric SQL)
 * Generated by entity codegen - do not edit directly
 */

import {
	Controller,
	Get,
	Body,
	Delete,
	Param,
	ParseUUIDPipe,
	Post,
	Put,
	Req,
	Res,
	UseGuards,
	UsePipes,
} from '@nestjs/common';
import type { Request, Response } from 'express';
import { AuthGuard } from '<%= imports.controllerToAuthGuard %>/auth.guard';
import { CurrentUser } from '<%= imports.controllerToCurrentUser %>/current-user.decorator';
import { User } from '<%= imports.controllerToDomain %>/user';
import { ElectricService } from '<%= imports.controllerToElectricService %>/electric.service';
import { <%= plural %>Columns } from '<%= locations.dbSchemaClient.import %>';
import {
	type Create<%= className %>Dto,
	create<%= className %>Schema,
	type Update<%= className %>Dto,
	update<%= className %>Schema,
} from '<%= imports.controllerToSchemas %>';
import { <%= createCommandClass %> } from '<%= imports.controllerToCreateCommand %>';
import { <%= deleteCommandClass %> } from '<%= imports.controllerToDeleteCommand %>';
import { <%= updateCommandClass %> } from '<%= imports.controllerToUpdateCommand %>';
import { <%= getByIdQueryClass %> } from '<%= imports.controllerToGetByIdQuery %>';
import { ZodValidationPipe } from '../../core/pipes/zod-validation.pipe';
import { <%= className %> } from '<%= imports.controllerToDomain %>';

@Controller('<%= plural %>')
@UseGuards(AuthGuard)
export class <%= classNamePlural %>Controller {
	constructor(
		private readonly electricService: ElectricService,
		private readonly get<%= className %>ByIdQuery: <%= getByIdQueryClass %>,
		private readonly create<%= className %>Command: <%= createCommandClass %>,
		private readonly update<%= className %>Command: <%= updateCommandClass %>,
		private readonly delete<%= className %>Command: <%= deleteCommandClass %>,
	) {}

	@Get()
	async findAll(
		@CurrentUser() user: User,
		@Req() req: Request,
		@Res() res: Response,
	): Promise<void> {
		return this.electricService.proxyRequest({
			req,
			res,
			table: '<%= table %>',
			columns: <%= plural %>Columns,
			where: `"<%= electricWhereColumn %>" = '${<%= electricWhereValue %>}'`,
		});
	}

	@Get(':id')
	async findById(@Param('id', ParseUUIDPipe) id: string): Promise<<%= className %>> {
		return this.get<%= className %>ByIdQuery.execute(id);
	}

	@Post()
	@UsePipes(new ZodValidationPipe(create<%= className %>Schema))
	async create(@Body() dto: Create<%= className %>Dto): Promise<<%= className %>> {
		return this.create<%= className %>Command.execute(dto);
	}

	@Put(':id')
	async update(
		@Param('id', ParseUUIDPipe) id: string,
		@Body(new ZodValidationPipe(update<%= className %>Schema)) dto: Update<%= className %>Dto,
	): Promise<<%= className %>> {
		return this.update<%= className %>Command.execute(id, dto);
	}

	@Delete(':id')
	async delete(@Param('id', ParseUUIDPipe) id: string): Promise<<%= className %>> {
		return this.delete<%= className %>Command.execute(id);
	}
}
<% } -%>
